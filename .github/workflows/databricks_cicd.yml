name: Databricks DLT CI/CD

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Install Databricks CLI v2
      run: pip install databricks-cli

    - name: Configure Databricks CLI
      run: |
        export DATABRICKS_HOST="${{ secrets.DATABRICKS_HOST }}"
        export DATABRICKS_TOKEN="${{ secrets.DATABRICKS_TOKEN }}"
        databricks configure --token <<< "${DATABRICKS_HOST}"$'\n'"${DATABRICKS_TOKEN}"

    - name: Create or Update Pipeline
      run: |
        databricks pipelines update --json-file dlt_pipeline/pipeline.json || \
        databricks pipelines create --json-file dlt_pipeline/pipeline.json

    - name: Trigger Pipeline Run
      run: |
        PIPELINE_ID=$(jq -r '.id' dlt_pipeline/pipeline.json)
        databricks pipelines start --pipeline-id "$PIPELINE_ID"
