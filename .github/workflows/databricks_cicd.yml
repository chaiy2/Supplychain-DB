name: Databricks DLT CI/CD

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Install Databricks CLI v2
      run: pip install databricks-cli>=0.205

    - name: Configure Databricks CLI
      run: |
        echo "DATABRICKS_HOST=${{ secrets.DATABRICKS_HOST }}" >> $GITHUB_ENV
        echo "DATABRICKS_TOKEN=${{ secrets.DATABRICKS_TOKEN }}" >> $GITHUB_ENV

    - name: Deploy DLT Pipeline
      run: |
        databricks pipelines create --file dlt_pipeline/pipeline.json || \
        databricks pipelines edit --file dlt_pipeline/pipeline.json

    - name: Trigger Pipeline Run
      run: |
        PIPELINE_ID=$(cat dlt_pipeline/pipeline.json | jq -r '.id')
        databricks pipelines start --pipeline-id $PIPELINE_ID
